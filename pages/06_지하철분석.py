import streamlit as st
import pandas as pd
import plotly.express as px

# ------------------------------------------------------
# ğŸ”§ ê¸°ë³¸ ì„¤ì •
# ------------------------------------------------------
st.set_page_config(page_title="ì§€í•˜ì²  ë¶„ì„", layout="wide")
st.title("ğŸš‡ ì„œìš¸ ì§€í•˜ì²  ìŠ¹í•˜ì°¨ ë¶„ì„ (2055ë…„ 10ì›”)")


# ------------------------------------------------------
# ğŸ“‚ ë°ì´í„° ë¡œë“œ
# ------------------------------------------------------
@st.cache_data
def load_data():
    # ğŸ”¥ ë£¨íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì•¼ Streamlit Cloud ì˜¤ë¥˜ ì—†ìŒ
    return pd.read_csv("subway.csv", encoding="cp949")

df = load_data()
df["ì‚¬ìš©ì¼ì"] = df["ì‚¬ìš©ì¼ì"].astype(str)


# ------------------------------------------------------
# ğŸšï¸ ì‚¬ìš©ì ì„ íƒ: í˜¸ì„ 
# ------------------------------------------------------
line_list = sorted(df["ë…¸ì„ ëª…"].unique())
selected_line = st.selectbox("í˜¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”", line_list)


# ------------------------------------------------------
# ğŸ” ë°ì´í„° í•„í„°ë§ (ë‚ ì§œ ê³ ì •)
# ------------------------------------------------------
# 2055ë…„ 10ì›” ë°ì´í„°ì—ì„œ íŠ¹ì • í˜¸ì„ ë§Œ ë‚¨ê¹€
filtered = df[df["ë…¸ì„ ëª…"] == selected_line].copy()

# ìŠ¹í•˜ì°¨ ì´í•© ìƒì„±
filtered["ì´ìŠ¹í•˜ì°¨"] = filtered["ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜"] + filtered["í•˜ì°¨ì´ìŠ¹ê°ìˆ˜"]

# ìŠ¹í•˜ì°¨ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬
filtered = filtered.sort_values("ì´ìŠ¹í•˜ì°¨", ascending=False)


# ------------------------------------------------------
# ğŸ¨ ìƒ‰ìƒ ì„¤ì •: 1ë“± ë¹¨ê°• / ë‚˜ë¨¸ì§€ íŒŒë‘ â†’ ì—°í•œ íŒŒë‘ ê·¸ë¼ë°ì´ì…˜
# ------------------------------------------------------
colors = ["red"]
blues = px.colors.sequential.Blues[::-1]

for i in range(1, len(filtered)):
    colors.append(blues[min(i, len(blues) - 1)])


# ------------------------------------------------------
# ğŸ“Š Plotly ë§‰ëŒ€ ê·¸ë˜í”„
# ------------------------------------------------------
fig = px.bar(
    filtered,
    x="ì—­ëª…",
    y="ì´ìŠ¹í•˜ì°¨",
    color=filtered["ì—­ëª…"],
    color_discrete_sequence=colors,
    title=f"{selected_line} ìŠ¹í•˜ì°¨ TOP ì—­ ìˆœìœ„",
)

fig.update_layout(
    xaxis_title="ì—­ëª…",
    yaxis_title="ì´ ìŠ¹í•˜ì°¨(ëª…)",
    showlegend=False,
    bargap=0.15,
)

st.plotly_chart(fig, use_container_width=True)


# ------------------------------------------------------
# ğŸ“„ ë°ì´í„° í…Œì´ë¸”
# ------------------------------------------------------
st.subheader("ğŸ“˜ í•„í„°ë§ëœ ë°ì´í„°")
st.dataframe(filtered)
